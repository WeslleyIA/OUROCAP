<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUROCAP - Sistema em Nuvem</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ============================================================
           1. CSS GERAL
           ============================================================ */
        :root {
            --primary: #FFD700;
            --bg: #0a0a0a;
            --card: #141414;
            --text: #ffffff;
            --dim: #888;
            --border: #222;
            --success: #00ff88;
            --danger: #ff4d4d;
            --info: #29b6f6;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* ============================================================
           2. TELA DE LOGIN
           ============================================================ */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('background.png') no-repeat center center;
            background-size: cover;
            display: flex; 
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #login-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); 
            z-index: 1;
        }

        .login-box {
            position: relative; z-index: 2;
            background: rgba(20, 20, 20, 0.95);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--primary);
            width: 100%; max-width: 400px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            margin: 20px; /* Margem para n√£o colar na borda em celulares */
        }

        .login-box h1 {
            font-family: 'Archivo Black'; color: var(--primary);
            margin-bottom: 30px; font-size: 2rem;
            text-transform: uppercase;
        }

        .login-field { margin-bottom: 20px; text-align: left; }
        .login-field input { width: 100%; margin-top: 5px; }
        
        .error-msg {
            color: var(--danger); font-size: 0.8rem; margin-bottom: 15px; display: none;
        }

        #app-content { display: none; width: 100%; height: 100%; display: flex; }


        /* ============================================================
           3. CSS DA INTERFACE DO SISTEMA (DESKTOP PADR√ÉO)
           ============================================================ */
        nav { width: 240px; border-right: 1px solid var(--border); padding: 40px 20px; display: flex; flex-direction: column; flex-shrink: 0; justify-content: space-between; overflow-y: auto; }
        .nav-top { display: flex; flex-direction: column; }
        .logo { font-family: 'Archivo Black'; color: var(--primary); font-size: 1.5rem; margin-bottom: 40px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .nav-item { padding: 14px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: var(--dim); transition: 0.3s; font-size: 0.9rem; font-weight: 600; white-space: nowrap; }
        .nav-item:hover { background: #1a1a1a; color: #fff; }
        .nav-item.active { background: var(--primary); color: #000; }

        .user-area { border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
        .user-email { font-size: 0.75rem; color: #fff; margin-bottom: 10px; word-break: break-all; display: block; text-align: center; font-weight: bold; }
        .btn-logout { width: 100%; background: #333; color: var(--danger); border: 1px solid #444; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-logout:hover { background: var(--danger); color: #fff; border-color: var(--danger); }

        main { flex: 1; padding: 40px; overflow-y: auto; overflow-x: hidden; }
        .container { width: 100%; max-width: 1100px; margin: 0 auto; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; overflow-x: auto; /* Permite scroll na tabela se precisar */ }
        h2 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        h2::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* Grids Desktop */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 20px; margin-bottom: 20px; } 
        .grid-full { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
        .dash-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }

        .field { display: flex; flex-direction: column; gap: 8px; }
        .field label { font-size: 0.7rem; font-weight: 700; color: var(--dim); text-transform: uppercase; }
        input, select, textarea { background: #1d1d1d; border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 0.9rem; transition: 0.2s; width: 100%; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #222; }
        input[disabled] { opacity: 0.5; cursor: not-allowed; }

        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .radio-opt { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; }
        input[type="radio"] { accent-color: var(--primary); width: auto; margin: 0; }

        .btn { background: var(--primary); color: #000; border: none; padding: 15px 30px; border-radius: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; width: 100%; }
        .btn:hover { opacity: 0.9; }
        .btn-sec { background: #333; color: #fff; margin-left: 10px; }
        .btn-add { background: var(--success); color: #000; margin-top: 10px; }
        .btn-info { background: var(--info); color: #000; margin-top: 10px; }
        
        /* Ajuste de bot√µes em container flex */
        .btn-group-responsive { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-group-responsive button { flex: 1; white-space: nowrap; }

        .kpi { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); }
        .kpi span { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; }
        .kpi h3 { font-size: 1.6rem; margin-top: 10px; }

        table { width: 100%; border-collapse: collapse; min-width: 600px; /* Garante que a tabela n√£o esmague no mobile */ }
        th { text-align: left; padding: 15px; color: var(--dim); font-size: 0.7rem; border-bottom: 1px solid var(--border); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #1a1a1a; font-size: 0.85rem; vertical-align: middle; }
        .val-in { color: var(--success); }
        .val-out { color: var(--danger); }

        .action-btn { background: none; border: 1px solid #444; color: #fff; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: 0.2s; }
        .action-btn:hover { background: #333; }
        .btn-del { border-color: var(--danger); color: var(--danger); margin-left: 5px; }
        .btn-del:hover { background: var(--danger); color: #000; }
        
        .btn-stock { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--dim); background: transparent; color: #fff; cursor: pointer; margin: 0 5px; }
        .btn-stock:hover { background: var(--primary); color: #000; border-color: var(--primary); }

        /* ============================================================
           5. CSS RESPONSIVO (MOBILE E TABLET)
           ============================================================ */
        @media (max-width: 900px) {
            /* Mudar layout principal de linha para coluna */
            body { 
                flex-direction: column; 
                height: auto; 
                overflow-y: auto; /* Permite scroll da p√°gina toda no mobile */
            }

            /* Nav vira barra superior rol√°vel */
            nav { 
                width: 100%; 
                height: auto; 
                border-right: none; 
                border-bottom: 1px solid var(--border); 
                padding: 15px; 
                flex-direction: row; 
                align-items: center;
                overflow-x: auto; /* Scroll horizontal no menu */
                background: var(--card);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .nav-top { 
                flex-direction: row; 
                gap: 10px; 
                width: 100%;
                align-items: center;
            }

            .logo { 
                margin-bottom: 0; 
                border-bottom: none; 
                padding-bottom: 0; 
                margin-right: 20px;
                font-size: 1.2rem;
            }

            .nav-item { 
                padding: 8px 15px; 
                margin-bottom: 0; 
                font-size: 0.8rem;
                background: #111;
                border: 1px solid #333;
            }

            .user-area {
                display: none; /* Esconde logout no mobile para economizar espa√ßo, ou mover para o topo se preferir */
            }
            
            /* Para exibir o logout no mobile de forma compacta, se quiser, descomente: */
            /* .user-area { 
                display: block; 
                border-top: none; 
                padding-top: 0; 
                margin-left: auto; 
            }
            .user-email { display: none; }
            .btn-logout { width: auto; padding: 5px 10px; font-size: 0.7rem; }
            */

            main { 
                padding: 15px; 
                height: auto;
                overflow: visible;
            }

            .container { padding-bottom: 50px; }

            /* Transformar Grids em Coluna √önica */
            .grid-3, .grid-4, .grid-2 { 
                grid-template-columns: 1fr; 
                gap: 15px;
            }

            /* KPIs do Dashboard em 2 colunas (melhor que 1 fila enorme) */
            .dash-row { 
                grid-template-columns: 1fr 1fr; 
                gap: 10px;
            }

            .kpi { padding: 15px; }
            .kpi h3 { font-size: 1.2rem; }

            /* Tabelas com Scroll */
            .card { padding: 15px; }
            
            /* Bot√µes */
            .btn { width: 100%; margin-left: 0 !important; margin-top: 10px; }
            .btn-group-responsive { flex-direction: column; }
            .btn-group-responsive button { width: 100%; margin: 0; }
        }

        /* ============================================================
           4. CSS DE IMPRESS√ÉO (Mantido igual)
           ============================================================ */
        #printArea { display: none; }

        @media print {
            @page { margin: 10mm; size: A4; } 
            
            body, html { height: 100%; margin: 0; background: white !important; }
            body * { display: none !important; }
            
            #printArea, #printArea * { display: block !important; visibility: visible !important; }
            
            #printArea { 
                position: absolute; top: 0; left: 0; width: 100%; 
                background: white !important; color: black !important; 
                padding: 0; margin: 0;
            }

            .print-container { 
                height: auto; 
                display: flex; 
                flex-direction: column; 
                justify-content: flex-start; 
                gap: 20px;
                font-family: 'Arial', sans-serif;
            }
            
            .print-content { 
                display: flex;
                flex-direction: column;
                gap: 15px; 
            }

            .print-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: flex-start; 
                border-bottom: 4px solid #000; 
                padding-bottom: 10px; 
                margin-bottom: 10px; 
            }
            .print-logo { max-width: 130px; height: auto; object-fit: contain; }
            .os-num { text-align: right; }
            .os-num p { font-size: 11pt; margin: 0; font-weight: bold; }
            .os-num h2 { font-size: 26pt; margin: 0; color: #000; line-height: 1; } 
            .os-num span { font-size: 11pt; display: block; margin-top: 5px;}

            .print-section { border: 2px solid #000; border-radius: 8px; overflow: hidden; }
            .print-section h3 { 
                background: #ddd; padding: 8px 15px; font-size: 11pt; 
                text-transform: uppercase; border-bottom: 2px solid #000; 
                margin: 0; font-weight: 800; 
            }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
            .print-item { font-size: 11pt; margin-bottom: 5px; display: flex; flex-direction: column; }
            .print-item b { text-transform: uppercase; font-size: 9pt; color: #444; margin-bottom: 2px; }
            .print-item span { font-weight: 600; font-size: 12pt; color: #000; } 

            .print-warranty { 
                font-size: 9pt; text-align: justify; border: 2px dashed #000; 
                padding: 10px; line-height: 1.3; background: #f9f9f9; 
            }

            .print-value { 
                padding: 15px; 
                border: 3px solid #000; 
                display: flex;             
                justify-content: space-between; 
                align-items: center;       
                font-size: 18pt; 
                font-weight: 800; 
                background: #eee; 
                border-radius: 8px; 
            }

            .print-footer { 
                width: 100%; 
                padding-top: 50px; 
                padding-bottom: 10px; 
            }
            .sig-box { 
                width: 45%; border-top: 3px solid #000; padding-top: 5px; 
                text-align: center; font-weight: bold; font-size: 10pt; text-transform: uppercase; 
            }
            .sig-resp { float: left; }
            .sig-cli { float: right; }

            /* MODO RECIBO (80MM) */
            .modo-recibo .print-container { height: auto; width: 80mm; border: none; margin: 0; padding: 5px; display: block; }
            .modo-recibo .print-header { border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; flex-direction: column; text-align: center; align-items: center; }
            .modo-recibo .print-logo { max-width: 60mm; max-height: 80px; margin-bottom: 5px; }
            .modo-recibo .os-num { text-align: center; margin-top: 5px; }
            .modo-recibo .os-num p { font-size: 10pt; }
            .modo-recibo .os-num h2 { font-size: 16pt; margin: 5px 0; }
            .modo-recibo .os-num span { font-size: 10pt; }
            .modo-recibo .print-section { border: none; margin-bottom: 10px; border-radius: 0; }
            .modo-recibo .print-section h3 { border: none; border-bottom: 1px solid #000; background: transparent; padding: 2px 0; font-size: 10pt; margin-top: 5px; }
            .modo-recibo .print-grid { display: block; padding: 5px 0; gap: 0; }
            .modo-recibo .print-item { margin-bottom: 5px; border-bottom: 1px dotted #ccc; padding-bottom: 2px; display: flex; flex-direction: row; justify-content: space-between; }
            .modo-recibo .print-item b { font-size: 8pt; margin: 0; }
            .modo-recibo .print-item span { font-size: 9pt; text-align: right; }
            .modo-recibo .print-warranty { font-size: 7pt; border: none; border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px; background: transparent; margin-top: 10px; }
            .modo-recibo .print-value { display: block; border: 2px dashed #000; text-align: center; margin: 10px 0; font-size: 14pt; padding: 10px; background: transparent; border-radius: 0; }
            .modo-recibo .print-footer { padding-top: 20px; }
            .modo-recibo .sig-box { width: 100%; float: none; margin-bottom: 30px; font-size: 9pt; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-overlay"></div>
        <div class="login-box">
            <h1>OUROCAP</h1>
            <div id="login-error" class="error-msg">Email ou senha incorretos.</div>
            <form id="formLogin">
                <div class="field login-field">
                    <label>E-mail</label>
                    <input type="email" id="l-email" required placeholder="admin@ourocap.com">
                </div>
                <div class="field login-field">
                    <label>Senha</label>
                    <input type="password" id="l-pass" required placeholder="********">
                </div>
                <button type="submit" class="btn" id="btn-entrar">ENTRAR NO SISTEMA</button>
            </form>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        <nav>
            <div class="nav-top">
                <div class="logo">OUROCAP</div>
                <div class="nav-item active" onclick="showPage('dash', this)">Dashboard</div>
                <div class="nav-item" onclick="showPage('clientes', this)">Clientes</div> 
                <div class="nav-item" onclick="showPage('os', this)">Nova OS</div>
                <div class="nav-item" onclick="showPage('prod', this)">Produ√ß√£o</div>
                <div class="nav-item" onclick="showPage('stock', this)">Estoque</div>
                <div class="nav-item" onclick="showPage('fin', this)">Financeiro</div>
            </div>
            
            <div class="user-area">
                <span class="user-email" id="display-email">...</span>
                <button class="btn-logout" id="btn-logout">SAIR</button>
            </div>
        </nav>

        <main>
            <div class="container">
                
                <div id="dash" class="page active">
                    <div class="dash-row">
                        <div class="kpi"><span>Receita Total</span><h3 id="k-rev" style="color:var(--success)">R$ 0,00</h3></div>
                        <div class="kpi"><span>Custos</span><h3 id="k-exp" style="color:var(--danger)">R$ 0,00</h3></div>
                        <div class="kpi"><span>OS Ativas</span><h3 id="k-os">0</h3></div>
                        <div class="kpi"><span>Lucro</span><h3 id="k-profit">R$ 0,00</h3></div>
                    </div>
                    <div class="card">
                        <h2>Vis√£o Geral</h2>
                        <canvas id="mainChart" height="100"></canvas>
                    </div>
                </div>

                <div id="clientes" class="page">
                    <div class="card">
                        <h2>Cadastro Completo de Cliente</h2>
                        <form id="formCliente">
                            <div class="radio-group">
                                <label class="radio-opt">
                                    <input type="radio" name="tipoPessoa" value="PF" checked onclick="toggleDocMask()"> Pessoa F√≠sica
                                </label>
                                <label class="radio-opt">
                                    <input type="radio" name="tipoPessoa" value="PJ" onclick="toggleDocMask()"> Pessoa Jur√≠dica
                                </label>
                            </div>

                            <div class="grid-full">
                                <div class="field"><label>Nome / Raz√£o Social</label><input type="text" id="cli-nome" required></div>
                            </div>

                            <div class="grid-3">
                                <div class="field"><label>CPF / CNPJ</label><input type="text" id="cli-doc" onkeyup="mascaraDoc(this)" required></div>
                                <div class="field"><label>Inscri√ß√£o Estadual (IE)</label><input type="text" id="cli-ie" placeholder="Isento se PF"></div>
                                <div class="field"><label>Telefone / Zap</label><input type="text" id="cli-fone" onkeyup="mascaraFone(this)" required></div>
                            </div>

                            <div class="grid-3">
                                <div class="field"><label>Email (Opcional)</label><input type="email" id="cli-email"></div>
                                <div class="field"><label>Placa / Frota</label><input type="text" id="cli-placa"></div>
                                <div class="field"><label>CEP (Busca Auto)</label><input type="text" id="cli-cep" onkeyup="mascaraCep(this)" onblur="buscarCep(this.value)" placeholder="00000-000"></div>
                            </div>

                            <div class="grid-4">
                                <div class="field"><label>Rua</label><input type="text" id="cli-rua"></div>
                                <div class="field"><label>Bairro</label><input type="text" id="cli-bairro"></div>
                                <div class="field"><label>N√∫mero</label><input type="text" id="cli-num"></div>
                                <div class="field"><label>Cidade/UF</label><input type="text" id="cli-cidade"></div>
                            </div>

                            <button type="submit" class="btn btn-info">Salvar Ficha do Cliente</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Base de Clientes (Nuvem)</h2>
                        <table>
                            <thead><tr><th>Nome/Raz√£o</th><th>CPF/CNPJ</th><th>IE</th><th>Cidade</th><th>A√ß√£o</th></tr></thead>
                            <tbody id="lista-clientes"></tbody>
                        </table>
                    </div>
                </div>

                <div id="os" class="page">
                    <div class="card">
                        <h2>Dados da Ordem de Servi√ßo</h2>
                        <form id="formOS">
                            <div class="grid-full">
                                <div class="field">
                                    <label>Selecione o Cliente Cadastrado</label>
                                    <input type="text" id="os-cliente" list="lista-clientes-sugestao" required autocomplete="off" placeholder="Digite nome ou CPF para buscar...">
                                    <datalist id="lista-clientes-sugestao"></datalist>
                                    <small style="color:var(--dim); margin-top:5px">‚ö†Ô∏è Cliente deve estar cadastrado na aba "Clientes"</small>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="field"><label>Marca (Fabricante)</label><input type="text" id="os-marca" required placeholder="Ex: Vipal, Maggion..."></div>
                                <div class="field"><label>Modelo / Medida</label>
                                    <select id="os-medida" required>
                                        <option value="">Selecione...</option>
                                        <option value="Pneu Broz traseiro 110/90-17">Pneu Broz traseiro 110/90-17</option>
                                        <option value="Pneu Broz dianteiro 90/90-19">Pneu Broz dianteiro 90/90-19</option>
                                        <option value="Pneu Titan traseiro 90/90-18">Pneu Titan traseiro 90/90-18</option>
                                        <option value="Pneu Titan dianteiro 2.75-18">Pneu Titan dianteiro 2.75-18</option>
                                        <option value="Pneu Biz traseiro 80/100-14">Pneu Biz traseiro 80/100-14</option>
                                        <option value="Pneu Biz dianteiro 2.50-17">Pneu Biz dianteiro 2.50-17</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid-3">
                                <div class="field"><label>Pre√ßo Servi√ßo (R$)</label>
                                    <input type="text" id="os-preco" onkeyup="mascaraMoeda(this)" required placeholder="0,00">
                                </div>
                                <div class="field"><label>Quantidade</label>
                                    <input type="number" id="os-qtd" value="1" min="1" required>
                                </div>
                                <div class="field"><label>Status Inicial</label>
                                    <select id="os-status">
                                        <option>Aguardando</option>
                                        <option>Na Raspagem</option>
                                        <option>Pronto</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="btn-group-responsive">
                                <button type="submit" class="btn" onclick="document.getElementById('formOS').dataset.printType = 'a4'">Salvar e Imprimir A4</button>
                                <button type="submit" class="btn btn-sec" onclick="document.getElementById('formOS').dataset.printType = 'recibo'">Salvar e Imprimir Recibo üßæ</button>
                                <button type="submit" class="btn btn-add" onclick="document.getElementById('formOS').dataset.printType = 'saveonly'">Apenas Salvar üíæ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="prod" class="page">
                    <div class="card">
                        <h2>Fila de Trabalho (Sincronizado)</h2>
                        <table>
                            <thead><tr><th>OS #</th><th>Qtd</th><th>Pneu/Medida</th><th>Cliente</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                            <tbody id="lista-prod"></tbody>
                        </table>
                    </div>
                </div>

                <div id="stock" class="page">
                    <div class="card">
                        <h2>Novo Item / Entrada</h2>
                        <form id="formStock">
                            <div class="grid-3">
                                <div class="field"><label>Item</label><input type="text" id="st-item" required placeholder="Ex: Cola, Borracha..."></div>
                                <div class="field"><label>Quantidade Inicial</label><input type="number" id="st-qtd" required></div>
                                <div class="field"><label>Alerta M√≠nimo</label><input type="number" id="st-min" value="5"></div>
                            </div>
                            <button type="submit" class="btn btn-add" style="width:auto">Cadastrar / Adicionar</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Controle de Invent√°rio</h2>
                        <table id="tabela-estoque">
                            <thead><tr><th>Item</th><th>Quantidade</th><th>Ajuste R√°pido</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                            <tbody id="lista-estoque"></tbody>
                        </table>
                    </div>
                </div>

                <div id="fin" class="page">
                    <div class="card">
                        <h2>Lan√ßar Movimenta√ß√£o</h2>
                        <form id="formFin">
                            <div class="grid-3">
                                <div class="field"><label>Descri√ß√£o</label><input type="text" id="f-desc" required></div>
                                <div class="field"><label>Valor (R$)</label>
                                    <input type="text" id="f-val" onkeyup="mascaraMoeda(this)" placeholder="0,00" required>
                                </div>
                                <div class="field"><label>Tipo</label>
                                    <select id="f-tipo">
                                        <option value="in">Receita (+)</option>
                                        <option value="out">Despesa (-)</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn" style="width:auto">Lan√ßar Agora</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Hist√≥rico Financeiro</h2>
                        <table>
                            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                            <tbody id="lista-fin"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="printArea">
        <div id="printContainer" class="print-container">
            <div class="print-header">
                <img src="logo.jpg" class="print-logo" alt="Logo Ourocap">
                <div class="os-num">
                    <p>ORDEM DE SERVI√áO</p>
                    <h2 id="p-id">#0000</h2>
                    <span id="p-data">00/00/0000</span>
                </div>
            </div>
            <div class="print-content">
                <div class="print-section">
                    <h3>Dados do Cliente</h3>
                    <div class="print-grid">
                        <div class="print-item"><b>Nome/Raz√£o:</b><span id="p-cliente">---</span></div>
                        <div class="print-item"><b>CPF/CNPJ:</b><span id="p-doc">---</span></div>
                        <div class="print-item"><b>Insc. Estadual:</b><span id="p-ie">---</span></div>
                        <div class="print-item"><b>Fone:</b><span id="p-fone">---</span></div>
                        <div class="print-item"><b>Placa:</b><span id="p-placa">---</span></div>
                        <div class="print-item" style="grid-column: span 1;"><b>Endere√ßo:</b><span id="p-endereco">---</span></div>
                    </div>
                </div>
                <div class="print-section">
                    <h3>Dados do Servi√ßo / Pneu</h3>
                    <div class="print-grid">
                        <div class="print-item"><b>Marca do Pneu:</b><span id="p-marca">---</span></div>
                        <div class="print-item"><b>Modelo/Medida:</b><span id="p-medida">---</span></div>
                        <div class="print-item"><b>Quantidade:</b><span id="p-qtd">---</span></div>
                    </div>
                </div>
                <div class="print-warranty">
                    <b>TERMO DE GARANTIA:</b><br>
                    A OUROCAP garante seus servi√ßos de recapagem contra descolamento de banda por 6 meses ou at√© atingir o TWI. 
                    N√£o cobrimos danos por furos, cortes acidentais, avarias mec√¢nicas no ve√≠culo ou carca√ßas com mais de 5 anos.
                    Ao assinar, o cliente declara estar ciente das condi√ß√µes da carca√ßa no ato da entrega.
                </div>
                <div class="print-value">
                    <span>VALOR TOTAL:</span> 
                    <span>R$ <span id="p-valor">0,00</span></span>
                </div>
            </div> 
            <div class="print-footer">
                <div class="sig-box sig-resp">Respons√°vel Ourocap</div>
                <div class="sig-box sig-cli">Assinatura do Cliente</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURA√á√ÉO DO FIREBASE (Sua conta)
        const firebaseConfig = {
            apiKey: "AIzaSyADFrQH__itlLVX4s3svENktUurejWpD-g",
            authDomain: "ourocap-f96a9.firebaseapp.com",
            projectId: "ourocap-f96a9",
            storageBucket: "ourocap-f96a9.firebasestorage.app",
            messagingSenderId: "736888471312",
            appId: "1:736888471312:web:f197f2cf7d6df224ddef95",
            measurementId: "G-3JWK1H79LC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // VARI√ÅVEIS GLOBAIS DE DADOS
        let listaClientes = [];
        let listaOS = [];
        let listaEstoque = [];
        let listaFin = [];
        let myChart = null;

        // Elementos de Login e App
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const displayEmail = document.getElementById('display-email');
        const errorMsg = document.getElementById('login-error');

        // Monitorar Login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                appContent.style.display = 'flex';
                displayEmail.innerText = user.email;
                iniciarSincronizacaoEmTempoReal();
            } else {
                loginScreen.style.display = 'flex';
                appContent.style.display = 'none';
                displayEmail.innerText = '';
            }
        });

        // ---------------------------------------------------------
        // FUN√á√ÉO DE SINCRONIZA√á√ÉO EM TEMPO REAL
        // ---------------------------------------------------------
        function iniciarSincronizacaoEmTempoReal() {
            // 1. CLIENTES
            const qCli = query(collection(db, "clientes"), orderBy("nome"));
            onSnapshot(qCli, (snapshot) => {
                listaClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientes();
                updateClientSuggestions();
            });

            // 2. OS
            const qOS = query(collection(db, "os")); 
            onSnapshot(qOS, (snapshot) => {
                listaOS = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                listaOS.sort((a,b) => b.id - a.id);
                renderOS();
                updateDashboard();
            });

            // 3. ESTOQUE
            onSnapshot(collection(db, "estoque"), (snapshot) => {
                listaEstoque = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStock();
            });

            // 4. FINANCEIRO
            const qFin = query(collection(db, "financeiro"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(qFin, (snapshot) => {
                listaFin = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                renderFinance();
                updateDashboard();
            });
        }

        // --- FUN√á√ïES DE INTERFACE (UI) ---
        window.showPage = function(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'dash') updateDashboard();
        }

        // --- CLIENTES ---
        document.getElementById('formCliente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rua = document.getElementById('cli-rua').value;
            const num = document.getElementById('cli-num').value;
            const bairro = document.getElementById('cli-bairro').value;
            const cidade = document.getElementById('cli-cidade').value;
            const enderecoFull = `${rua}, ${num} - ${bairro} - ${cidade}`;

            const novoCliente = {
                tipo: document.querySelector('input[name="tipoPessoa"]:checked').value,
                nome: document.getElementById('cli-nome').value,
                doc: document.getElementById('cli-doc').value,
                ie: document.getElementById('cli-ie').value || "Isento",
                fone: document.getElementById('cli-fone').value,
                email: document.getElementById('cli-email').value,
                placa: document.getElementById('cli-placa').value,
                cep: document.getElementById('cli-cep').value,
                endereco: enderecoFull
            };
            
            try {
                await addDoc(collection(db, "clientes"), novoCliente);
                e.target.reset();
                alert("Cliente salvo na nuvem!");
            } catch (err) {
                console.error("Erro ao salvar:", err);
                alert("Erro ao salvar. Verifique sua conex√£o.");
            }
        });

        function renderClientes() {
            document.getElementById('lista-clientes').innerHTML = listaClientes.map(c => `
                <tr>
                    <td>
                        <div style="font-weight:bold">${c.nome}</div>
                        <div style="font-size:0.7rem; color:#888">${c.email || ''}</div>
                    </td>
                    <td>${c.doc || '-'}</td>
                    <td>${c.ie || '-'}</td>
                    <td>${c.endereco ? c.endereco.split('-').pop() : '-'}</td>
                    <td><button class="action-btn btn-del" onclick="deletarItem('clientes', '${c.id}')">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function updateClientSuggestions() {
            const dataList = document.getElementById('lista-clientes-sugestao');
            dataList.innerHTML = listaClientes.map(c => `<option value="${c.nome} - ${c.doc}">`).join('');
        }

        // --- OS (ORDEM DE SERVI√áO) ---
        document.getElementById('formOS').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const inputVal = document.getElementById('os-cliente').value;
            let clienteEncontrado = listaClientes.find(c => `${c.nome} - ${c.doc}` === inputVal || c.nome.toLowerCase() === inputVal.toLowerCase().split(' - ')[0]);

            if (!clienteEncontrado) {
                alert("ERRO: Cliente n√£o encontrado! Cadastre-o primeiro.");
                return; 
            }

            const preco = limparValor(document.getElementById('os-preco').value);
            // Captura o tipo de impress√£o ou padr√£o "saveonly"
            const printType = e.target.dataset.printType || 'saveonly';

            const idVisual = Math.floor(1000 + Math.random() * 9000);

            const novaOS = {
                id: idVisual, 
                cliente: clienteEncontrado.nome,
                doc: clienteEncontrado.doc,
                ie: clienteEncontrado.ie || "Isento",
                endereco: clienteEncontrado.endereco,
                fone: clienteEncontrado.fone,
                placa: clienteEncontrado.placa,
                marca: document.getElementById('os-marca').value,
                medida: document.getElementById('os-medida').value,
                qtd: document.getElementById('os-qtd').value,
                preco: preco,
                status: document.getElementById('os-status').value,
                data: new Date().toLocaleDateString('pt-BR'),
                createdAt: Date.now() 
            };

            try {
                // 1. Salvar OS
                await addDoc(collection(db, "os"), novaOS);

                // 2. Lan√ßar Financeiro
                const finEntry = { 
                    createdAt: Date.now(), 
                    data: novaOS.data, 
                    desc: `OS #${novaOS.id} - ${novaOS.cliente}`, 
                    val: novaOS.preco, 
                    tipo: 'in' 
                };
                await addDoc(collection(db, "financeiro"), finEntry);

                // 3. Imprimir SE NECESS√ÅRIO
                if(printType !== 'saveonly') {
                    gerarDocumento(novaOS, printType);
                } else {
                    alert("OS #" + novaOS.id + " Salva com Sucesso!");
                }

                e.target.reset();
                document.getElementById('os-qtd').value = 1;

            } catch(err) {
                console.error(err);
                alert("Erro ao salvar OS. Tente novamente.");
            }
        });

        function renderOS() {
            document.getElementById('lista-prod').innerHTML = listaOS.map(os => `
                <tr>
                    <td>#${os.id}</td>
                    <td>${os.qtd || 1}</td>
                    <td style="font-size:0.8rem">${os.medida}</td>
                    <td>
                        <div>${os.cliente}</div>
                        <div style="font-size:0.65rem; color:#666">${os.doc || ''}</div>
                    </td>
                    <td style="color:var(--primary)">${os.status}</td>
                    <td>
                        <button class="action-btn" onclick="reimprimir('${os.firebaseId}', 'a4')">üñ®Ô∏è</button>
                        <button class="action-btn" onclick="reimprimir('${os.firebaseId}', 'recibo')">üßæ</button>
                        <button class="action-btn btn-del" onclick="deletarItem('os', '${os.firebaseId}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        window.reimprimir = function(firebaseId, tipo) {
            const os = listaOS.find(x => x.firebaseId === firebaseId);
            if(os) gerarDocumento(os, tipo);
        }

        // --- ESTOQUE ---
        document.getElementById('formStock').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemNome = document.getElementById('st-item').value;
            const existe = listaEstoque.find(x => x.nome.toLowerCase() === itemNome.toLowerCase());

            if(existe) {
                const novaQtd = parseInt(existe.qtd) + parseInt(document.getElementById('st-qtd').value);
                const docRef = doc(db, "estoque", existe.id);
                await updateDoc(docRef, { qtd: novaQtd });
                alert("Quantidade atualizada!");
            } else {
                const item = {
                    nome: itemNome,
                    qtd: parseInt(document.getElementById('st-qtd').value),
                    min: parseInt(document.getElementById('st-min').value)
                };
                await addDoc(collection(db, "estoque"), item);
                alert("Item cadastrado!");
            }
            e.target.reset();
        });

        function renderStock() {
            document.getElementById('lista-estoque').innerHTML = listaEstoque.map(i => `
                <tr>
                    <td>${i.nome}</td>
                    <td><b>${i.qtd}</b> un</td>
                    <td>
                        <button class="btn-stock" onclick="alterarEstoque('${i.id}', ${i.qtd}, -1)">-</button>
                        <button class="btn-stock" onclick="alterarEstoque('${i.id}', ${i.qtd}, 1)">+</button>
                    </td>
                    <td style="color:${i.qtd <= i.min ? 'var(--danger)' : 'var(--success)'}">${i.qtd <= i.min ? 'BAIXO' : 'OK'}</td>
                    <td><button class="action-btn btn-del" onclick="deletarItem('estoque', '${i.id}')">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        window.alterarEstoque = async function(docId, qtdAtual, delta) {
            const novaQtd = qtdAtual + delta;
            if(novaQtd < 0) return;
            const docRef = doc(db, "estoque", docId);
            await updateDoc(docRef, { qtd: novaQtd });
        };

        // --- FINANCEIRO ---
        document.getElementById('formFin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = limparValor(document.getElementById('f-val').value);
            if(isNaN(val) || val === 0) { alert("Valor inv√°lido."); return; }
            
            const entry = {
                createdAt: Date.now(),
                data: new Date().toLocaleDateString('pt-BR'),
                desc: document.getElementById('f-desc').value, 
                val: val, 
                tipo: document.getElementById('f-tipo').value
            };
            
            await addDoc(collection(db, "financeiro"), entry);
            e.target.reset(); 
            document.getElementById('f-val').value = "";
        });

        function renderFinance() {
            document.getElementById('lista-fin').innerHTML = listaFin.map(f => {
                let valorSeguro = (typeof f.val === 'number' && !isNaN(f.val)) ? f.val : 0;
                return `<tr><td>${f.data}</td><td>${f.desc}</td>
                <td class="${f.tipo === 'in' ? 'val-in' : 'val-out'}">${f.tipo === 'in' ? '+' : '-'} ${valorSeguro.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                <td><button class="action-btn btn-del" onclick="deletarItem('financeiro', '${f.firebaseId}')">üóëÔ∏è</button></td></tr>`
            }).join('');
        }

        window.deletarItem = async function(colecao, id) {
            if(confirm("Tem certeza que deseja excluir?")) {
                try {
                    await deleteDoc(doc(db, colecao, id));
                } catch(e) {
                    alert("Erro ao excluir: " + e.message);
                }
            }
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const rec = listaFin.filter(x => x.tipo === 'in').reduce((acc, curr) => acc + (curr.val || 0), 0);
            const exp = listaFin.filter(x => x.tipo === 'out').reduce((acc, curr) => acc + (curr.val || 0), 0);
            document.getElementById('k-rev').innerText = rec.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('k-exp').innerText = exp.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('k-os').innerText = listaOS.length;
            document.getElementById('k-profit').innerText = (rec - exp).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const ctx = document.getElementById('mainChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Atual'],
                    datasets: [{ label: 'Faturamento', data: [0, 0, 0, 0, rec], borderColor: '#FFD700', fill: false, tension: 0.4 }]
                }, options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { color: '#222' } } } }
            });
        }

        // --- LOGIN LOGIC ---
        document.getElementById('formLogin').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('l-email').value;
            const pass = document.getElementById('l-pass').value;
            const btn = document.getElementById('btn-entrar');
            btn.innerText = "VERIFICANDO...";
            errorMsg.style.display = 'none';
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => { btn.innerText = "ENTRAR NO SISTEMA"; })
                .catch((error) => {
                    btn.innerText = "ENTRAR NO SISTEMA";
                    errorMsg.style.display = 'block';
                    console.error("Erro login:", error);
                });
        });
        document.getElementById('btn-logout').addEventListener('click', () => {
            if(confirm("Deseja realmente sair?")) signOut(auth);
        });

        // --- HELPERS E IMPRESS√ÉO ---
        window.limparValor = function(valStr) { if(!valStr) return 0; return parseFloat(valStr.replace(/\./g, '').replace(',', '.')); }
        window.mascaraMoeda = function(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); i.value = v; }
        window.mascaraFone = function(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v.substring(0, 15); }
        window.mascaraCep = function(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{5})(\d)/, "$1-$2"); i.value = v.substring(0, 9); }
        window.toggleDocMask = function() { document.getElementById('cli-doc').value = ""; }
        window.mascaraDoc = function(i) { 
            const tipo = document.querySelector('input[name="tipoPessoa"]:checked').value;
            let v = i.value.replace(/\D/g, "");
            if (tipo === 'PF') { v = v.substring(0, 11); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); } 
            else { v = v.substring(0, 14); v = v.replace(/^(\d{2})(\d)/, "$1.$2"); v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3"); v = v.replace(/\.(\d{3})(\d)/, ".$1/$2"); v = v.replace(/(\d{4})(\d)/, "$1-$2"); }
            i.value = v; 
        }
        window.buscarCep = async function(cep) {
            cep = cep.replace(/\D/g, '');
            if(cep.length === 8) {
                try { document.getElementById('cli-rua').value = "Buscando..."; const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const data = await response.json(); if(!data.erro) { document.getElementById('cli-rua').value = data.logradouro; document.getElementById('cli-bairro').value = data.bairro; document.getElementById('cli-cidade').value = `${data.localidade}/${data.uf}`; document.getElementById('cli-num').focus(); } else { alert("CEP n√£o encontrado."); document.getElementById('cli-rua').value = ""; } } catch(e) { console.error(e); }
            }
        }
        function gerarDocumento(os, tipo) {
            document.getElementById('p-id').innerText = "#" + os.id;
            document.getElementById('p-data').innerText = os.data;
            document.getElementById('p-cliente').innerText = os.cliente;
            document.getElementById('p-doc').innerText = os.doc || "---"; 
            document.getElementById('p-ie').innerText = os.ie || "Isento";
            document.getElementById('p-fone').innerText = os.fone || "---";
            document.getElementById('p-placa').innerText = os.placa || "---";
            document.getElementById('p-endereco').innerText = os.endereco || "N√£o informado"; 
            document.getElementById('p-marca').innerText = os.marca;
            document.getElementById('p-medida').innerText = os.medida;
            document.getElementById('p-qtd').innerText = os.qtd || "1";
            let valorPrint = (typeof os.preco === 'number') ? os.preco : 0;
            document.getElementById('p-valor').innerText = valorPrint.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            const printArea = document.getElementById('printArea');
            if(tipo === 'recibo') printArea.classList.add('modo-recibo');
            else printArea.classList.remove('modo-recibo');
            setTimeout(() => { window.print(); }, 300);
        }
    </script>
</body>
</html>
